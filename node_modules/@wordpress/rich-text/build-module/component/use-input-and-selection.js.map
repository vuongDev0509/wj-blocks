{"version":3,"sources":["@wordpress/rich-text/src/component/use-input-and-selection.js"],"names":["useRef","useRefEffect","getActiveFormats","updateFormats","INSERTION_INPUT_TYPES_TO_IGNORE","Set","EMPTY_ACTIVE_FORMATS","fixPlaceholderSelection","defaultView","selection","getSelection","anchorNode","anchorOffset","nodeType","ELEMENT_NODE","targetNode","childNodes","getAttribute","collapseToStart","useInputAndSelection","props","propsRef","current","element","ownerDocument","isComposing","rafId","onInput","event","inputType","record","applyRecord","createRecord","handleChange","indexOf","has","currentValue","start","activeFormats","oldActiveFormats","change","value","end","formats","handleSelectionChange","isSelected","onSelectionChange","activeElement","contains","focusNode","offset","undefined","type","text","oldRecord","length","newValue","_newActiveFormats","newActiveFormats","domOnly","onCompositionStart","removeEventListener","onCompositionEnd","addEventListener","onFocus","parentElement","closest","index","requestAnimationFrame","cancelAnimationFrame"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useRef } from '@wordpress/element';\nimport { useRefEffect } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport { getActiveFormats } from '../get-active-formats';\nimport { updateFormats } from '../update-formats';\n\n/**\n * All inserting input types that would insert HTML into the DOM.\n *\n * @see https://www.w3.org/TR/input-events-2/#interface-InputEvent-Attributes\n *\n * @type {Set}\n */\nconst INSERTION_INPUT_TYPES_TO_IGNORE = new Set( [\n\t'insertParagraph',\n\t'insertOrderedList',\n\t'insertUnorderedList',\n\t'insertHorizontalRule',\n\t'insertLink',\n] );\n\nconst EMPTY_ACTIVE_FORMATS = [];\n\n/**\n * If the selection is set on the placeholder element, collapse the selection to\n * the start (before the placeholder).\n *\n * @param {Window} defaultView\n */\nfunction fixPlaceholderSelection( defaultView ) {\n\tconst selection = defaultView.getSelection();\n\tconst { anchorNode, anchorOffset } = selection;\n\n\tif ( anchorNode.nodeType !== anchorNode.ELEMENT_NODE ) {\n\t\treturn;\n\t}\n\n\tconst targetNode = anchorNode.childNodes[ anchorOffset ];\n\n\tif (\n\t\t! targetNode ||\n\t\ttargetNode.nodeType !== targetNode.ELEMENT_NODE ||\n\t\t! targetNode.getAttribute( 'data-rich-text-placeholder' )\n\t) {\n\t\treturn;\n\t}\n\n\tselection.collapseToStart();\n}\n\nexport function useInputAndSelection( props ) {\n\tconst propsRef = useRef( props );\n\tpropsRef.current = props;\n\treturn useRefEffect( ( element ) => {\n\t\tconst { ownerDocument } = element;\n\t\tconst { defaultView } = ownerDocument;\n\n\t\tlet isComposing = false;\n\t\tlet rafId;\n\n\t\tfunction onInput( event ) {\n\t\t\t// Do not trigger a change if characters are being composed.\n\t\t\t// Browsers  will usually emit a final `input` event when the\n\t\t\t// characters are composed.\n\t\t\t// As of December 2019, Safari doesn't support\n\t\t\t// nativeEvent.isComposing.\n\t\t\tif ( isComposing ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet inputType;\n\n\t\t\tif ( event ) {\n\t\t\t\tinputType = event.inputType;\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\trecord,\n\t\t\t\tapplyRecord,\n\t\t\t\tcreateRecord,\n\t\t\t\thandleChange,\n\t\t\t} = propsRef.current;\n\n\t\t\t// The browser formatted something or tried to insert HTML.\n\t\t\t// Overwrite it. It will be handled later by the format library if\n\t\t\t// needed.\n\t\t\tif (\n\t\t\t\tinputType &&\n\t\t\t\t( inputType.indexOf( 'format' ) === 0 ||\n\t\t\t\t\tINSERTION_INPUT_TYPES_TO_IGNORE.has( inputType ) )\n\t\t\t) {\n\t\t\t\tapplyRecord( record.current );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst currentValue = createRecord();\n\t\t\tconst {\n\t\t\t\tstart,\n\t\t\t\tactiveFormats: oldActiveFormats = [],\n\t\t\t} = record.current;\n\n\t\t\t// Update the formats between the last and new caret position.\n\t\t\tconst change = updateFormats( {\n\t\t\t\tvalue: currentValue,\n\t\t\t\tstart,\n\t\t\t\tend: currentValue.start,\n\t\t\t\tformats: oldActiveFormats,\n\t\t\t} );\n\n\t\t\thandleChange( change );\n\t\t}\n\n\t\t/**\n\t\t * Syncs the selection to local state. A callback for the `selectionchange`\n\t\t * native events, `keyup`, `mouseup` and `touchend` synthetic events, and\n\t\t * animation frames after the `focus` event.\n\t\t *\n\t\t * @param {Event|DOMHighResTimeStamp} event\n\t\t */\n\t\tfunction handleSelectionChange( event ) {\n\t\t\tconst {\n\t\t\t\trecord,\n\t\t\t\tapplyRecord,\n\t\t\t\tcreateRecord,\n\t\t\t\tisSelected,\n\t\t\t\tonSelectionChange,\n\t\t\t} = propsRef.current;\n\n\t\t\t// If the selection changes where the active element is a parent of\n\t\t\t// the rich text instance (writing flow), call `onSelectionChange`\n\t\t\t// for the rich text instance that contains the start or end of the\n\t\t\t// selection.\n\t\t\tif ( ownerDocument.activeElement !== element ) {\n\t\t\t\tif ( ! ownerDocument.activeElement.contains( element ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst selection = defaultView.getSelection();\n\t\t\t\tconst { anchorNode, focusNode } = selection;\n\n\t\t\t\tif (\n\t\t\t\t\telement.contains( anchorNode ) &&\n\t\t\t\t\telement !== anchorNode &&\n\t\t\t\t\telement.contains( focusNode ) &&\n\t\t\t\t\telement !== focusNode\n\t\t\t\t) {\n\t\t\t\t\tconst { start, end } = createRecord();\n\t\t\t\t\trecord.current.activeFormats = EMPTY_ACTIVE_FORMATS;\n\t\t\t\t\tonSelectionChange( start, end );\n\t\t\t\t} else if (\n\t\t\t\t\telement.contains( anchorNode ) &&\n\t\t\t\t\telement !== anchorNode\n\t\t\t\t) {\n\t\t\t\t\tconst { start, end: offset = start } = createRecord();\n\t\t\t\t\trecord.current.activeFormats = EMPTY_ACTIVE_FORMATS;\n\t\t\t\t\tonSelectionChange( offset );\n\t\t\t\t} else if (\n\t\t\t\t\telement.contains( focusNode ) &&\n\t\t\t\t\telement !== focusNode\n\t\t\t\t) {\n\t\t\t\t\tconst { start, end: offset = start } = createRecord();\n\t\t\t\t\trecord.current.activeFormats = EMPTY_ACTIVE_FORMATS;\n\t\t\t\t\tonSelectionChange( undefined, offset );\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( event.type !== 'selectionchange' && ! isSelected ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// In case of a keyboard event, ignore selection changes during\n\t\t\t// composition.\n\t\t\tif ( isComposing ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { start, end, text } = createRecord();\n\t\t\tconst oldRecord = record.current;\n\n\t\t\t// Fallback mechanism for IE11, which doesn't support the input event.\n\t\t\t// Any input results in a selection change.\n\t\t\tif ( text !== oldRecord.text ) {\n\t\t\t\tonInput();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( start === oldRecord.start && end === oldRecord.end ) {\n\t\t\t\t// Sometimes the browser may set the selection on the placeholder\n\t\t\t\t// element, in which case the caret is not visible. We need to set\n\t\t\t\t// the caret before the placeholder if that's the case.\n\t\t\t\tif ( oldRecord.text.length === 0 && start === 0 ) {\n\t\t\t\t\tfixPlaceholderSelection( defaultView );\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst newValue = {\n\t\t\t\t...oldRecord,\n\t\t\t\tstart,\n\t\t\t\tend,\n\t\t\t\t// _newActiveFormats may be set on arrow key navigation to control\n\t\t\t\t// the right boundary position. If undefined, getActiveFormats will\n\t\t\t\t// give the active formats according to the browser.\n\t\t\t\tactiveFormats: oldRecord._newActiveFormats,\n\t\t\t\t_newActiveFormats: undefined,\n\t\t\t};\n\n\t\t\tconst newActiveFormats = getActiveFormats(\n\t\t\t\tnewValue,\n\t\t\t\tEMPTY_ACTIVE_FORMATS\n\t\t\t);\n\n\t\t\t// Update the value with the new active formats.\n\t\t\tnewValue.activeFormats = newActiveFormats;\n\n\t\t\t// It is important that the internal value is updated first,\n\t\t\t// otherwise the value will be wrong on render!\n\t\t\trecord.current = newValue;\n\t\t\tapplyRecord( newValue, { domOnly: true } );\n\t\t\tonSelectionChange( start, end );\n\t\t}\n\n\t\tfunction onCompositionStart() {\n\t\t\tisComposing = true;\n\t\t\t// Do not update the selection when characters are being composed as\n\t\t\t// this rerenders the component and might distroy internal browser\n\t\t\t// editing state.\n\t\t\townerDocument.removeEventListener(\n\t\t\t\t'selectionchange',\n\t\t\t\thandleSelectionChange\n\t\t\t);\n\t\t}\n\n\t\tfunction onCompositionEnd() {\n\t\t\tisComposing = false;\n\t\t\t// Ensure the value is up-to-date for browsers that don't emit a final\n\t\t\t// input event after composition.\n\t\t\tonInput( { inputType: 'insertText' } );\n\t\t\t// Tracking selection changes can be resumed.\n\t\t\townerDocument.addEventListener(\n\t\t\t\t'selectionchange',\n\t\t\t\thandleSelectionChange\n\t\t\t);\n\t\t}\n\n\t\tfunction onFocus() {\n\t\t\tconst {\n\t\t\t\trecord,\n\t\t\t\tisSelected,\n\t\t\t\tonSelectionChange,\n\t\t\t\tapplyRecord,\n\t\t\t} = propsRef.current;\n\n\t\t\t// When the whole editor is editable, let writing flow handle\n\t\t\t// selection.\n\t\t\tif ( element.parentElement.closest( '[contenteditable=\"true\"]' ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( ! isSelected ) {\n\t\t\t\t// We know for certain that on focus, the old selection is invalid.\n\t\t\t\t// It will be recalculated on the next mouseup, keyup, or touchend\n\t\t\t\t// event.\n\t\t\t\tconst index = undefined;\n\n\t\t\t\trecord.current = {\n\t\t\t\t\t...record.current,\n\t\t\t\t\tstart: index,\n\t\t\t\t\tend: index,\n\t\t\t\t\tactiveFormats: EMPTY_ACTIVE_FORMATS,\n\t\t\t\t};\n\t\t\t\tonSelectionChange( index, index );\n\t\t\t} else {\n\t\t\t\tapplyRecord( record.current );\n\t\t\t\tonSelectionChange( record.current.start, record.current.end );\n\t\t\t}\n\n\t\t\t// Update selection as soon as possible, which is at the next animation\n\t\t\t// frame. The event listener for selection changes may be added too late\n\t\t\t// at this point, but this focus event is still too early to calculate\n\t\t\t// the selection.\n\t\t\trafId = defaultView.requestAnimationFrame( handleSelectionChange );\n\t\t}\n\n\t\telement.addEventListener( 'input', onInput );\n\t\telement.addEventListener( 'compositionstart', onCompositionStart );\n\t\telement.addEventListener( 'compositionend', onCompositionEnd );\n\t\telement.addEventListener( 'focus', onFocus );\n\t\t// Selection updates must be done at these events as they\n\t\t// happen before the `selectionchange` event. In some cases,\n\t\t// the `selectionchange` event may not even fire, for\n\t\t// example when the window receives focus again on click.\n\t\telement.addEventListener( 'keyup', handleSelectionChange );\n\t\telement.addEventListener( 'mouseup', handleSelectionChange );\n\t\telement.addEventListener( 'touchend', handleSelectionChange );\n\t\townerDocument.addEventListener(\n\t\t\t'selectionchange',\n\t\t\thandleSelectionChange\n\t\t);\n\t\treturn () => {\n\t\t\telement.removeEventListener( 'input', onInput );\n\t\t\telement.removeEventListener(\n\t\t\t\t'compositionstart',\n\t\t\t\tonCompositionStart\n\t\t\t);\n\t\t\telement.removeEventListener( 'compositionend', onCompositionEnd );\n\t\t\telement.removeEventListener( 'focus', onFocus );\n\t\t\telement.removeEventListener( 'keyup', handleSelectionChange );\n\t\t\telement.removeEventListener( 'mouseup', handleSelectionChange );\n\t\t\telement.removeEventListener( 'touchend', handleSelectionChange );\n\t\t\townerDocument.removeEventListener(\n\t\t\t\t'selectionchange',\n\t\t\t\thandleSelectionChange\n\t\t\t);\n\t\t\tdefaultView.cancelAnimationFrame( rafId );\n\t\t};\n\t}, [] );\n}\n"]}